<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Miskatonic Quiz - Quiz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
  <!-- Bootstrap first -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Then custom theme to override Bootstrap -->
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Barre de navigation -->
  <nav class="navbar shadow-sm mb-4">
    <div class="container d-flex justify-content-between">
      <span class="brand">Miskatonic Quiz</span>
      <div>
        <a id="nav-admin" href="admin.html" class="btn btn-secondary btn-sm me-2 d-none">Admin</a>
        <span id="welcome-user" class="me-3 small-muted"></span>
        <button id="btn-logout" class="btn btn-danger btn-sm">D√©connexion</button>
      </div>
    </div>
  </nav>

  <!-- Contenu principal -->
  <main class="container">
    <div class="row">
      <div class="col-md-8 mx-auto">
        <!-- Carte Quiz -->
        <div class="card">
          <h2 id="quiz-title">Quiz en cours</h2>
          <div class="d-flex align-items-center gap-2 mb-3">
            <label for="select-limit" class="form-label m-0">Nombre de questions:</label>
            <select id="select-limit" class="form-select" style="width:auto">
              <option value="5">5</option>
              <option value="10">10</option>
            </select>
            <button id="btn-reload" class="btn btn-outline-secondary btn-sm">Relancer al√©atoire</button>
            <button id="btn-delete-quiz" class="btn btn-outline-danger btn-sm">Supprimer ce quiz</button>
          </div>
          <div id="quiz-body"><div class="p-3 small-muted">Chargement‚Ä¶</div></div>
        </div>
      </div>
    </div>
  </main>

  <!-- JS -->
  <script>
  const API_BASE = "http://127.0.0.1:8000";

    // V√©rifier connexion utilisateur + r√¥le
    const user = localStorage.getItem("misk_user");
    const role = localStorage.getItem("misk_role");
    if (!user || !role) {
      alert("Vous devez vous connecter.");
      window.location.href = "index.html";
    } else {
      document.getElementById("welcome-user").innerText = `Connect√© : ${user} [${role}]`;
      if (["prof", "admin"].includes(role)) {
        document.getElementById("nav-admin").classList.remove("d-none");
      }
    }

    // D√©connexion
    document.getElementById("btn-logout").addEventListener("click", () => {
      localStorage.removeItem("misk_user");
      localStorage.removeItem("misk_role");
      window.location.href = "index.html";
    });

    // Variables du quiz
  let questions = [];
    let index = 0;
    let score = 0;
  let quizId = localStorage.getItem("misk_quiz_id") || null;
  let quizName = localStorage.getItem("misk_quiz_name") || ""; // conserv√© si quiz charg√© depuis sessions existantes
  let quizTheme = localStorage.getItem("misk_quiz_theme") || "";

    // Charger les questions
    async function startQuiz(limit = 5) {
      try {
          questions = [];
          // Essayer d'utiliser la s√©rie m√©moris√©e par questions.html
          const cached = localStorage.getItem("misk_quiz_set");
          if (cached) {
            try {
              const arr = JSON.parse(cached);
              if (Array.isArray(arr) && arr.length === Number(limit)) {
                questions = arr;
              }
            } catch (_) {
              // cache invalide, on l'ignore
            }
          }

          // Si un quiz_id serveur existe, il est prioritaire pour recharger exactement la m√™me session serveur
          if ((!Array.isArray(questions) || questions.length !== Number(limit)) && quizId) {
            try {
              const r = await fetch(`${API_BASE}/quiz/${quizId}`);
              if (r.ok) {
                const doc = await r.json();
                if (Array.isArray(doc.questions) && doc.questions.length === Number(limit)) {
                  questions = doc.questions;
                }
                if (doc.theme) {
                  quizTheme = doc.theme;
                  localStorage.setItem("misk_quiz_theme", quizTheme);
                }
              }
            } catch (_) { /* ignore */ }
          }

          // Si pas de cache valide, on tire une nouvelle s√©rie et on la m√©morise
          if (!Array.isArray(questions) || questions.length !== Number(limit)) {
            const url = new URL(`${API_BASE}/questions`);
            url.searchParams.set('limit', String(limit));
            if (quizTheme) url.searchParams.set('theme', quizTheme);
            const res = await fetch(url);
            if (!res.ok) throw new Error("Erreur API");
            questions = await res.json();
            localStorage.setItem("misk_quiz_set", JSON.stringify(questions));
            localStorage.setItem("misk_quiz_limit", String(limit));
          }

        if (questions.length === 0) {
          document.getElementById("quiz-body").innerHTML =
            `<div class="alert alert-warning">Aucune question disponible.</div>`;
          return;
        }
        index = 0;
        score = 0;
        const titleEl = document.getElementById("quiz-title");
        if (titleEl) {
          const base = "Quiz en cours";
          let txt = base;
          if (quizName) txt += ` ‚Äì ${quizName}`; // optionnel si session nomm√©e
          if (quizTheme) txt += ` ¬∑ ${quizTheme}`;
          titleEl.textContent = txt;
        }
        showQuestion();
      } catch (err) {
        console.error(err);
        document.getElementById("quiz-body").innerHTML =
          `<div class="alert alert-danger">Impossible de charger le quiz.</div>`;
      }
    }

    // Afficher une question
    function showQuestion() {
      const q = questions[index];
      document.getElementById("quiz-body").innerHTML = `
        <h5>${q.question}</h5>
        <p class="small-muted">Th√®me : ${q.theme} | Niveau : ${q.niveau}</p>
        <form id="quiz-form">
          ${q.choix.map((c, i) => `
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="opt-${i}" value="${c}">
              <label class="form-check-label choice-label" for="opt-${i}">${c}</label>
            </div>
          `).join("")}
        </form>
        <div class="d-grid gap-2 mt-3">
          <button id="btn-validate" class="btn btn-success">Valider</button>
        </div>
      `;
      document.getElementById("btn-validate").addEventListener("click", validateAnswer);
    }

    // Valider une r√©ponse
    async function validateAnswer(e) {
      e.preventDefault();
      const q = questions[index];
      const selected = Array.from(document.querySelectorAll("#quiz-form input:checked"))
        .map(el => el.value);

      try {
        const res = await fetch(`${API_BASE}/answer`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            username: user,
            quiz_id: quizId,
            question: q.question,
            reponse: selected
          })
        });
        if (!res.ok) throw new Error("Erreur API");
        const body = await res.json();

        // Coloration des r√©ponses
        document.querySelectorAll("#quiz-form input").forEach(el => {
          const label = el.nextElementSibling;
          if (q.correct.includes(el.value)) {
            label.classList.add("correct");
          }
          if (el.checked && !q.correct.includes(el.value)) {
            label.classList.add("wrong");
          }
          el.disabled = true;
        });

        if (body.correct) score++;

        // Bouton suivant
        document.getElementById("quiz-body").innerHTML += `
          <div class="d-grid gap-2 mt-3">
            <button id="btn-next" class="btn btn-primary">Suivant</button>
          </div>
        `;
        document.getElementById("btn-next").addEventListener("click", nextQuestion);

      } catch (err) {
        console.error(err);
        alert("Erreur lors de la validation.");
      }
    }

    // Passer √† la question suivante ou terminer
    function nextQuestion() {
      index++;
      if (index < questions.length) {
        showQuestion();
      } else {
        showResults();
      }
    }

    // Afficher le score final
    function showResults() {
      document.getElementById("quiz-body").innerHTML = `
        <div class="text-center">
          <h4>Quiz termin√© üéâ</h4>
          <p>Score : <strong>${score} / ${questions.length}</strong></p>
          <div class="d-grid mt-3">
            <button id="btn-retry" class="btn btn-outline-primary">Rejouer</button>
            <a href="questions.html" class="btn btn-secondary">Retour aux questions</a>
          </div>
        </div>
      `;
      document.getElementById("btn-retry").addEventListener("click", () => {
        const limit = parseInt(localStorage.getItem("misk_quiz_limit") || "5", 10);
        // Nouvelle s√©rie au rejouer
        localStorage.removeItem("misk_quiz_set");
        startQuiz(limit);
      });
    }

    // Bouton relancer
    document.getElementById("btn-reload").addEventListener("click", () => {
      const limit = parseInt(document.getElementById("select-limit").value, 10) || 5;
        // Forcer une nouvelle s√©rie: vider le cache avant de relancer
        localStorage.removeItem("misk_quiz_set");
        localStorage.removeItem("misk_quiz_id");
        localStorage.removeItem("misk_quiz_name");
        quizId = null;
        quizName = "";
      localStorage.setItem("misk_quiz_limit", String(limit));
      startQuiz(limit);
    });

    // Supprimer ce quiz c√¥t√© serveur
    document.getElementById("btn-delete-quiz").addEventListener("click", async () => {
      if (!quizId) {
        alert("Aucun quiz √† supprimer.");
        return;
      }
      if (!confirm("Supprimer d√©finitivement ce quiz ?")) return;
      try {
        const res = await fetch(`${API_BASE}/quiz/${encodeURIComponent(quizId)}?username=${encodeURIComponent(user)}`, { method: "DELETE" });
        if (!res.ok) {
          const body = await res.json().catch(() => ({}));
          throw new Error(body.detail || "Suppression impossible");
        }
        // Nettoyage local et retour
        localStorage.removeItem("misk_quiz_set");
        localStorage.removeItem("misk_quiz_id");
        alert("Quiz supprim√©.");
        window.location.href = "questions.html";
      } catch (err) {
        alert(err.message || "Erreur de suppression");
      }
    });
      // Note: le bouton #btn-retry n'existe qu'apr√®s l'affichage des r√©sultats et est bind√© dans showResults()

    // Lancer au d√©marrage avec la limite sauvegard√©e ou 5
  const savedLimit = parseInt(localStorage.getItem("misk_quiz_limit") || "5", 10);
    document.getElementById("select-limit").value = String([5,10].includes(savedLimit) ? savedLimit : 5);
    startQuiz(savedLimit);
  </script>
  <!-- Background music (tiny inline script for autoplay policies) -->
  <audio id="bgm" src="assets/bg.mp3" preload="auto" loop hidden></audio>
  <script>
    (function(){
      const audio = document.getElementById('bgm');
      if (!audio) return;
      const KEY_START = 'misk_bgm_start_ms';
      const KEY_VOL = 'misk_bgm_vol';
      const now = Date.now();
      if (!localStorage.getItem(KEY_START)) {
        localStorage.setItem(KEY_START, String(now));
      }
      const startMs = parseInt(localStorage.getItem(KEY_START) || String(now), 10) || now;
      const vol = parseFloat(localStorage.getItem(KEY_VOL) || '0.25');

      function setOffset() {
        const dur = audio.duration;
        if (isFinite(dur) && dur > 0) {
          const elapsed = (Date.now() - startMs) / 1000;
          audio.currentTime = (elapsed % dur);
        }
      }

      function resume() {
        audio.muted = false;
        audio.volume = vol;
        setOffset();
        const p = audio.play();
        if (p && typeof p.then === 'function') {
          p.then(() => {
            document.removeEventListener('pointerdown', resume);
            document.removeEventListener('keydown', resume);
          }).catch(() => {});
        } else {
          document.removeEventListener('pointerdown', resume);
          document.removeEventListener('keydown', resume);
        }
      }

      audio.addEventListener('loadedmetadata', setOffset);
      audio.volume = vol;
      setOffset();
      audio.play().catch(() => {});
      document.addEventListener('pointerdown', resume, { once: true });
      document.addEventListener('keydown', resume, { once: true });
      audio.addEventListener('volumechange', () => {
        localStorage.setItem(KEY_VOL, String(audio.volume));
      });
    })();
  </script>
</body>
</html>
