<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Miskatonic Quiz - Quiz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Google Fonts + style global -->
  <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <!-- Barre de navigation -->
  <nav class="navbar shadow-sm mb-4">
    <div class="container d-flex justify-content-between">
      <span class="brand">Miskatonic Quiz</span>
      <div>
        <span id="welcome-user" class="me-3 small-muted"></span>
        <button id="btn-logout" class="btn btn-danger btn-sm">DÃ©connexion</button>
      </div>
    </div>
  </nav>

  <!-- Contenu principal -->
  <main class="container">
    <div class="row">
      <div class="col-md-8 mx-auto">
        <!-- Carte Quiz -->
        <div class="card">
          <h2 id="quiz-title">Quiz en cours</h2>
          <div id="quiz-body"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- JS -->
  <script>
    const API_BASE = "http://127.0.0.1:8000";

    // VÃ©rifier connexion utilisateur + rÃ´le
    const user = localStorage.getItem("misk_user");
    const role = localStorage.getItem("misk_role");
    if (!user || !role) {
      alert("Vous devez vous connecter.");
      window.location.href = "index.html";
    } else {
      document.getElementById("welcome-user").innerText = `ConnectÃ© : ${user} [${role}]`;
    }

    // DÃ©connexion
    document.getElementById("btn-logout").addEventListener("click", () => {
      localStorage.removeItem("misk_user");
      localStorage.removeItem("misk_role");
      window.location.href = "index.html";
    });

    // Variables du quiz
    let questions = [];
    let index = 0;
    let score = 0;

    // Charger les questions
    async function startQuiz(limit = 5) {
      try {
        const res = await fetch(`${API_BASE}/questions?limit=${limit}`);
        if (!res.ok) throw new Error("Erreur API");
        questions = await res.json();
        if (questions.length === 0) {
          document.getElementById("quiz-body").innerHTML =
            `<div class="alert alert-warning">Aucune question disponible.</div>`;
          return;
        }
        index = 0;
        score = 0;
        showQuestion();
      } catch (err) {
        console.error(err);
        document.getElementById("quiz-body").innerHTML =
          `<div class="alert alert-danger">Impossible de charger le quiz.</div>`;
      }
    }

    // Afficher une question
    function showQuestion() {
      const q = questions[index];
      document.getElementById("quiz-body").innerHTML = `
        <h5>${q.question}</h5>
        <p class="small-muted">ThÃ¨me : ${q.theme} | Niveau : ${q.niveau}</p>
        <form id="quiz-form">
          ${q.choix.map((c, i) => `
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="opt-${i}" value="${c}">
              <label class="form-check-label choice-label" for="opt-${i}">${c}</label>
            </div>
          `).join("")}
        </form>
        <div class="d-grid gap-2 mt-3">
          <button id="btn-validate" class="btn btn-success">Valider</button>
        </div>
      `;
      document.getElementById("btn-validate").addEventListener("click", validateAnswer);
    }

    // Valider une rÃ©ponse
    async function validateAnswer(e) {
      e.preventDefault();
      const q = questions[index];
      const selected = Array.from(document.querySelectorAll("#quiz-form input:checked"))
        .map(el => el.value);

      try {
        const res = await fetch(`${API_BASE}/answer`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            username: user,
            question: q.question,
            reponse: selected
          })
        });
        if (!res.ok) throw new Error("Erreur API");
        const body = await res.json();

        // Coloration des rÃ©ponses
        document.querySelectorAll("#quiz-form input").forEach(el => {
          const label = el.nextElementSibling;
          if (q.correct.includes(el.value)) {
            label.classList.add("correct");
          }
          if (el.checked && !q.correct.includes(el.value)) {
            label.classList.add("wrong");
          }
          el.disabled = true;
        });

        if (body.correct) score++;

        // Bouton suivant
        document.getElementById("quiz-body").innerHTML += `
          <div class="d-grid gap-2 mt-3">
            <button id="btn-next" class="btn btn-primary">Suivant</button>
          </div>
        `;
        document.getElementById("btn-next").addEventListener("click", nextQuestion);

      } catch (err) {
        console.error(err);
        alert("Erreur lors de la validation.");
      }
    }

    // Passer Ã  la question suivante ou terminer
    function nextQuestion() {
      index++;
      if (index < questions.length) {
        showQuestion();
      } else {
        showResults();
      }
    }

    // Afficher le score final
    function showResults() {
      document.getElementById("quiz-body").innerHTML = `
        <div class="text-center">
          <h4>Quiz terminÃ© ðŸŽ‰</h4>
          <p>Score : <strong>${score} / ${questions.length}</strong></p>
          <div class="d-grid mt-3">
            <button id="btn-retry" class="btn btn-outline-primary">Rejouer</button>
            <a href="questions.html" class="btn btn-secondary">Retour aux questions</a>
          </div>
        </div>
      `;
      document.getElementById("btn-retry").addEventListener("click", () => startQuiz(5));
    }

    // Lancer au dÃ©marrage
    startQuiz();
  </script>
</body>
</html>
