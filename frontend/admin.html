<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Miskatonic Quiz - Administration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <!-- Popup confirmation -->
  <div id="addPopup" class="popup-add" style="display:none">
    <div class="popup-add-content">
      <span class="close" id="closeAddPopup">&times;</span>
      <p>Nouvelle question ajoutée !</p>
    </div>
  </div>

  <nav class="navbar shadow-sm mb-4">
    <div class="container d-flex justify-content-between">
      <span class="brand">Miskatonic Quiz</span>
      <div>
        <a href="questions.html" class="btn btn-secondary btn-sm me-2">Questions</a>
        <a href="quiz.html" class="btn btn-secondary btn-sm me-2">Retour au quiz</a>
        <span id="welcome-user" class="me-3 small-muted"></span>
        <button id="btn-logout" class="btn btn-danger btn-sm">Déconnexion</button>
      </div>
    </div>
  </nav>

  <main class="container">
    <div class="row">
      <div class="col-md-10 mx-auto">
        <div class="card">
          <h2>Administration des questions</h2>
          <p class="small-muted">Réservé aux professeurs et administrateurs.</p>

          <div id="role-guard" class="alert alert-danger d-none">
            Accès refusé. Rôle requis: prof ou admin.
          </div>

          <div id="admin-body" class="d-none">
            <!-- Formulaire d'ajout -->
            <form id="form-add" class="mb-4">
              <h5>Ajouter une question</h5>
              <div class="mb-2">
                <label class="form-label">Intitulé de la question</label>
                <input id="q-text" class="form-control" required>
              </div>
              <div class="mb-2">
                <label class="form-label">Thème</label>
                <input id="q-theme" class="form-control" placeholder="Général">
              </div>
              <div class="mb-2">
                <label class="form-label">Test</label>
                <input id="q-test" class="form-control" placeholder="Quiz">
              </div>
              <div class="mb-2">
                <label class="form-label">Choix (un par ligne)</label>
                <textarea id="q-choix" class="form-control" rows="4" required></textarea>
              </div>
              <div class="mb-2">
                <label class="form-label">Réponses correctes (une par ligne)</label>
                <textarea id="q-correct" class="form-control" rows="3" required></textarea>
              </div>
              <div class="d-grid">
                <button type="submit" class="btn btn-success">Ajouter</button>
              </div>
            </form>

            <!-- Liste des questions -->
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5>Questions existantes</h5>
              <button id="btn-refresh" class="btn btn-outline-secondary btn-sm">Rafraîchir</button>
            </div>
            <div id="list" class="list-group"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    const API_BASE = "http://127.0.0.1:8000";
    const user = localStorage.getItem("misk_user");
    const role = localStorage.getItem("misk_role");

    // Vérification connexion et rôle
    if (!user || !role) {
      alert("Vous devez vous connecter.");
      window.location.href = "index.html";
    }

    document.getElementById("welcome-user").innerText = `Connecté : ${user} [${role}]`;

    if (!["prof", "admin"].includes(role)) {
      document.getElementById("role-guard").classList.remove("d-none");
    } else {
      document.getElementById("admin-body").classList.remove("d-none");
      loadQuestions();
    }

    // Déconnexion
    document.getElementById("btn-logout").addEventListener("click", () => {
      localStorage.clear();
      window.location.href = "index.html";
    });

    // ===== FONCTIONS PRINCIPALES =====
    
    async function loadQuestions() {
      const list = document.getElementById("list");
      list.innerHTML = "<div class='p-3 text-muted'>Chargement…</div>";
      
      try {
        const res = await fetch(`${API_BASE}/questions?admin=true&username=${encodeURIComponent(user)}`);
        if (!res.ok) throw new Error("Erreur API");
        const data = await res.json();
        
        list.innerHTML = "";
        if (!data || data.length === 0) {
          list.innerHTML = "<div class='alert alert-info'>Aucune question trouvée.</div>";
          return;
        }
        
        data.forEach(q => {
          const item = document.createElement("div");
          item.className = "list-group-item";
          item.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <h6 class="mb-1">${q.question}</h6>
                <p class="mb-1 small text-muted">Thème: ${q.theme} | Test: ${q.test}</p>
                <div class="small">Choix: ${q.choix.join(", ")}</div>
                <div class="small text-success">Correct: ${q.correct.join(", ")}</div>
              </div>
              <button class="btn btn-outline-danger btn-sm" onclick="deleteQuestion('${q.question.replace(/'/g, "\\'")}')">
                Supprimer
              </button>
            </div>
          `;
          list.appendChild(item);
        });
      } catch (err) {
        console.error(err);
        list.innerHTML = '<div class="alert alert-danger">Erreur lors du chargement.</div>';
      }
    }

    async function deleteQuestion(questionText) {
      if (!confirm("Supprimer cette question ?")) return;
      
      try {
        const res = await fetch(`${API_BASE}/questions`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username: user, question: questionText })
        });
        if (!res.ok) throw new Error("Erreur lors de la suppression");
        loadQuestions();
      } catch (err) {
        console.error(err);
        alert("Erreur: " + err.message);
      }
    }

    // Ajout de question
    document.getElementById("form-add").addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const question = document.getElementById("q-text").value.trim();
      const theme = document.getElementById("q-theme").value.trim() || "Général";
      const test = document.getElementById("q-test").value.trim() || "Quiz";
      const choixRaw = document.getElementById("q-choix").value.trim();
      const correctRaw = document.getElementById("q-correct").value.trim();

      if (!question || !choixRaw || !correctRaw) {
        alert("Veuillez remplir tous les champs obligatoires.");
        return;
      }

      const choix = choixRaw.split("\n").map(s => s.trim()).filter(s => s);
      const correct = correctRaw.split("\n").map(s => s.trim()).filter(s => s);

      try {
        const res = await fetch(`${API_BASE}/questions`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username: user, question, theme, test, choix, correct })
        });
        
        if (!res.ok) throw new Error("Erreur lors de l'ajout");
        
        document.getElementById("form-add").reset();
        document.getElementById("addPopup").style.display = "block";
        setTimeout(() => { document.getElementById("addPopup").style.display = "none"; }, 3000);
        
        loadQuestions();
      } catch (err) {
        console.error(err);
        alert("Erreur: " + err.message);
      }
    });

    // Event listeners
    document.getElementById("btn-refresh").addEventListener("click", loadQuestions);
    document.getElementById("closeAddPopup").addEventListener("click", () => {
      document.getElementById("addPopup").style.display = "none";
    });
  </script>
  
  <!-- Background music -->
  <audio id="bgm" src="assets/bg.mp3" preload="auto" loop hidden></audio>
  <script>
    const audio = document.getElementById('bgm');
    if (audio) {
      const KEY_START = 'misk_bgm_start_ms';
      const KEY_VOL = 'misk_bgm_vol';
      const now = Date.now();
      
      if (!localStorage.getItem(KEY_START)) {
        localStorage.setItem(KEY_START, String(now));
      }
      
      const startMs = parseInt(localStorage.getItem(KEY_START) || String(now), 10) || now;
      const vol = parseFloat(localStorage.getItem(KEY_VOL) || '0.25');

      function setOffset() {
        const dur = audio.duration;
        if (isFinite(dur) && dur > 0) {
          const elapsed = (Date.now() - startMs) / 1000;
          audio.currentTime = (elapsed % dur);
        }
      }

      audio.volume = vol;
      audio.addEventListener('loadedmetadata', setOffset);
      audio.play().catch(() => {
        document.addEventListener('click', () => {
          audio.play().catch(() => {});
        }, { once: true });
      });
    }
  </script>
</body>
</html>