<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Miskatonic Quiz - Admin Questions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
  <!-- Bootstrap first -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Then custom theme to override Bootstrap -->
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <nav class="navbar shadow-sm mb-4">
    <div class="container d-flex justify-content-between">
      <span class="brand">Miskatonic Quiz</span>
      <div>
        <a href="questions.html" class="btn btn-secondary btn-sm me-2">Questions</a>
        <a href="quiz.html" class="btn btn-secondary btn-sm me-2">Quiz</a>
        <span id="welcome-user" class="me-3 small-muted"></span>
        <button id="btn-logout" class="btn btn-danger btn-sm">D√©connexion</button>
      </div>
    </div>
  </nav>

  <main class="container">
    <div class="row">
      <div class="col-md-10 mx-auto">
        <div class="card">
          <h2>Administration des questions</h2>
          <p class="small-muted">R√©serv√© aux professeurs et administrateurs.</p>

          <div id="role-guard" class="alert alert-danger d-none">Acc√®s refus√©. R√¥le requis: prof ou admin.</div>

          <div id="admin-body" class="d-none">
            <form id="form-add" class="mb-4">
              <h5>Ajouter une question</h5>
              <div class="mb-2">
                <label class="form-label">Intitul√© de la question</label>
                <input id="q-text" class="form-control" required>
              </div>
              <div class="mb-2">
                <label class="form-label">Th√®me</label>
                <input id="q-theme" class="form-control" placeholder="G√©n√©ral">
              </div>
              <div class="mb-2">
                <label class="form-label">Niveau</label>
                <input id="q-niveau" class="form-control" placeholder="Facile">
              </div>
              <div class="mb-2">
                <label class="form-label">Choix (un par ligne)</label>
                <textarea id="q-choix" class="form-control" rows="4" required></textarea>
              </div>
              <div class="mb-2">
                <label class="form-label">R√©ponses correctes (une par ligne, doivent correspondre exactement √† un choix)</label>
                <textarea id="q-correct" class="form-control" rows="3" required></textarea>
              </div>
              <div class="d-grid">
                <button type="submit" class="btn btn-success">Ajouter</button>
              </div>
            </form>

            <h5>Questions existantes</h5>
            <div class="d-flex align-items-center gap-2 mb-2">
              <button id="btn-refresh" class="btn btn-outline-secondary btn-sm">Rafra√Æchir</button>
            </div>
            <div id="list" class="list-group"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    const API_BASE = "http://127.0.0.1:8000";
    const user = localStorage.getItem("misk_user");
    const role = localStorage.getItem("misk_role");

    if (!user || !role) {
      alert("Vous devez vous connecter.");
      window.location.href = "index.html";
    } else {
      document.getElementById("welcome-user").innerText = `Connect√© : ${user} [${role}]`;
    }

    document.getElementById("btn-logout").addEventListener("click", () => {
      localStorage.removeItem("misk_user");
      localStorage.removeItem("misk_role");
      window.location.href = "index.html";
    });

    function guardRole() {
      if (!["prof", "admin"].includes(role)) {
        document.getElementById("role-guard").classList.remove("d-none");
        return false;
      }
      document.getElementById("admin-body").classList.remove("d-none");
      return true;
    }

    async function loadAll() {
      const list = document.getElementById("list");
      list.innerHTML = "<div class='p-3 small-muted'>Chargement‚Ä¶</div>";
      try {
        const res = await fetch(`${API_BASE}/admin/questions?username=${encodeURIComponent(user)}`);
        if (!res.ok) throw new Error("Erreur API");
        const data = await res.json();
        if (!Array.isArray(data) || data.length === 0) {
          list.innerHTML = "<div class='alert alert-info'>Aucune question pour le moment.</div>";
          return;
        }
        list.innerHTML = "";
        data.forEach(q => {
          const el = document.createElement("div");
          el.className = "list-group-item";
          el.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h6 class="mb-1">${q.question}</h6>
                <p class="small-muted mb-1">Th√®me: ${q.theme} | Niveau: ${q.niveau}</p>
                <ul class="list-group small">
                  ${q.choix.map(c => `<li class='list-group-item'>ü´ß ${c}</li>`).join("")}
                </ul>
              </div>
              <div>
                <button class="btn btn-outline-danger btn-sm" data-q="${encodeURIComponent(q.question)}">Supprimer</button>
              </div>
            </div>`;
          list.appendChild(el);
        });

        // Bind delete buttons
        list.querySelectorAll("button[data-q]").forEach(btn => {
          btn.addEventListener("click", async () => {
            const q = decodeURIComponent(btn.getAttribute("data-q"));
            if (!confirm(`Supprimer la question:\n${q}`)) return;
            try {
              const res = await fetch(`${API_BASE}/admin/questions?username=${encodeURIComponent(user)}&question=${encodeURIComponent(q)}`, { method: "DELETE" });
              if (!res.ok) {
                const body = await res.json().catch(() => ({}));
                throw new Error(body.detail || "Suppression impossible");
              }
              await loadAll();
            } catch (err) {
              alert(err.message || "Erreur de suppression");
            }
          });
        });
      } catch (err) {
        console.error(err);
        list.innerHTML = `<div class='alert alert-danger'>Impossible de charger la liste.</div>`;
      }
    }

    document.getElementById("btn-refresh").addEventListener("click", loadAll);

    document.getElementById("form-add").addEventListener("submit", async (e) => {
      e.preventDefault();
      const question = document.getElementById("q-text").value.trim();
      const theme = document.getElementById("q-theme").value.trim();
      const niveau = document.getElementById("q-niveau").value.trim();
      const choix = document.getElementById("q-choix").value.split("\n").map(s => s.trim()).filter(Boolean);
      const correct = document.getElementById("q-correct").value.split("\n").map(s => s.trim()).filter(Boolean);
      if (!question || choix.length === 0 || correct.length === 0) {
        alert("Veuillez renseigner la question, au moins un choix et une r√©ponse correcte.");
        return;
      }
      // Validation simple: correct doit exister dans choix
      for (const c of correct) {
        if (!choix.includes(c)) {
          alert(`La r√©ponse correcte '${c}' ne correspond √† aucun choix.`);
          return;
        }
      }
      try {
        const res = await fetch(`${API_BASE}/admin/questions`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            username: user,
            question, theme, niveau,
            choix, correct
          })
        });
        if (!res.ok) {
          const body = await res.json().catch(() => ({}));
          throw new Error(body.detail || "Ajout impossible");
        }
  const form = document.getElementById("form-add");
  if (form && typeof form.reset === "function") form.reset();
        await loadAll();
      } catch (err) {
        alert(err.message || "Erreur d'ajout");
      }
    });

    if (guardRole()) {
      loadAll();
    }
  </script>
  <!-- Background music (tiny inline script for autoplay policies) -->
  <audio id="bgm" src="assets/bg.mp3" preload="auto" loop hidden></audio>
  <script>
    (function(){
      const audio = document.getElementById('bgm');
      if (!audio) return;
      const KEY_START = 'misk_bgm_start_ms';
      const KEY_VOL = 'misk_bgm_vol';
      const now = Date.now();
      if (!localStorage.getItem(KEY_START)) {
        localStorage.setItem(KEY_START, String(now));
      }
      const startMs = parseInt(localStorage.getItem(KEY_START) || String(now), 10) || now;
      const vol = parseFloat(localStorage.getItem(KEY_VOL) || '0.25');

      function setOffset() {
        const dur = audio.duration;
        if (isFinite(dur) && dur > 0) {
          const elapsed = (Date.now() - startMs) / 1000;
          audio.currentTime = (elapsed % dur);
        }
      }

      function resume() {
        audio.muted = false;
        audio.volume = vol;
        setOffset();
        const p = audio.play();
        if (p && typeof p.then === 'function') {
          p.then(() => {
            document.removeEventListener('pointerdown', resume);
            document.removeEventListener('keydown', resume);
          }).catch(() => {});
        } else {
          document.removeEventListener('pointerdown', resume);
          document.removeEventListener('keydown', resume);
        }
      }

      audio.addEventListener('loadedmetadata', setOffset);
      audio.volume = vol;
      setOffset();
      audio.play().catch(() => {});
      document.addEventListener('pointerdown', resume, { once: true });
      document.addEventListener('keydown', resume, { once: true });
      audio.addEventListener('volumechange', () => {
        localStorage.setItem(KEY_VOL, String(audio.volume));
      });
    })();
  </script>
</body>
</html>
