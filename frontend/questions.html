<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <title>Miskatonic Quiz - Questions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
  <!-- Bootstrap first -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Then custom theme to override Bootstrap -->
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <!-- Barre de navigation -->
  <nav class="navbar shadow-sm mb-4">
    <div class="container d-flex justify-content-between">
      <span class="brand">Miskatonic Quiz</span>
      <div>
        <a id="nav-admin" href="admin.html" class="btn btn-secondary btn-sm me-2 d-none">Admin</a>
        <span id="welcome-user" class="me-3 small-muted"></span>
        <button id="btn-logout" class="btn btn-danger btn-sm">Déconnexion</button>
      </div>
    </div>
  </nav>

  <!-- Contenu principal -->
  <main class="container">
    <div class="row">
      <div class="col-md-8 mx-auto">
        <!-- Carte Questions -->
        <div class="card">
          <h2 class="mb-3">Questions disponibles</h2>
          <div class="d-flex align-items-center gap-2 mb-3 flex-wrap controls-row">
            <label for="select-limit" class="form-label m-0">Nombre de questions:</label>
            <select id="select-limit" class="form-select" style="width:auto">
              <option value="5">5</option>
              <option value="10">10</option>
            </select>
            <select id="select-theme" class="form-select" style="width:auto">
              <option value="">Tous les thèmes</option>
            </select>
            <select id="select-test" class="form-select" style="width:auto">
              <option value="">Tous les tests</option>
            </select>
            <input id="input-quiz-name" class="form-control" style="min-width:220px; flex:1 1 260px; max-width:420px"
              placeholder="Nom du quiz (facultatif)">
            <button id="btn-refresh" class="btn btn-outline-secondary btn-sm">Rafraîchir aléatoire</button>
            <button id="btn-choose-quiz" class="btn btn-outline-primary btn-sm d-none">Choisir un quiz
              sauvegardé</button>
            <button id="btn-save-quiz" class="btn btn-success btn-sm d-none">Sauvegarder ce quiz</button>
          </div>
          <div id="questions-list" class="list-group"></div>
          <div class="d-grid mt-3">
            <button id="btn-start-quiz" class="btn btn-primary" disabled>Lancer le quiz</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- JS -->
  <script>
    const API_BASE = "http://127.0.0.1:8000";

    // Vérifier si l’utilisateur est connecté
    const user = localStorage.getItem("misk_user");
    const role = localStorage.getItem("misk_role");
    if (!user || !role) {
      alert("Vous devez vous connecter.");
      window.location.href = "index.html";
    } else {
      document.getElementById("welcome-user").innerText = `Connecté : ${user} [${role}]`;
      if (["prof", "admin"].includes(role)) {
        document.getElementById("nav-admin").classList.remove("d-none");
        document.getElementById("btn-choose-quiz").classList.remove("d-none");
        const btnSave = document.getElementById("btn-save-quiz");
        if (btnSave) btnSave.classList.remove("d-none");
      }
    }

    // Déconnexion
    document.getElementById("btn-logout").addEventListener("click", () => {
      localStorage.removeItem("misk_user");
      localStorage.removeItem("misk_role");
      window.location.href = "index.html";
    });

    // Charger et afficher les questions
    async function loadQuestions(limit = 10) {
      try {
        const theme = document.getElementById('select-theme').value || '';
        const url = new URL(`${API_BASE}/questions`);
        url.searchParams.set('limit', String(limit));
        if (theme) url.searchParams.set('theme', theme);
        const res = await fetch(url);
        if (!res.ok) throw new Error("Erreur API");
        const data = await res.json();


        // Stocke l'échantillon exact pour le quiz
        localStorage.setItem("misk_quiz_set", JSON.stringify(data));
        localStorage.setItem("misk_quiz_limit", String(limit));
        localStorage.setItem("misk_quiz_theme", theme || "");

        const list = document.getElementById("questions-list");
        list.innerHTML = "";
        data.forEach((q) => {
          const item = document.createElement("div");
          item.className = "list-group-item";
          item.innerHTML = `
            <h6>${q.question}</h6>
            <p class="small-muted">Thème : ${q.theme} | Test : ${q.test}</p>
            <ul class="list-group">
              ${q.choix.map(c => `<li class="list-group-item"> ${c}</li>`).join("")}
            </ul>
          `;
          list.appendChild(item);
        });

        // Autorise le lancement du quiz une fois la série prête
        document.getElementById("btn-start-quiz").disabled = false;
      } catch (err) {
        console.error(err);
        document.getElementById("questions-list").innerHTML =
          `<div class="alert alert-danger">Impossible de charger les questions.</div>`;
      }
    }

    // S'assure que la série est prête en cache avant de partir sur le quiz
    async function ensureQuizSet(limit) {
      try {
        const cached = localStorage.getItem("misk_quiz_set");
        if (cached) {
          try {
            const arr = JSON.parse(cached);
            if (Array.isArray(arr) && arr.length === Number(limit)) {
              return; // déjà prêt côté client
            }
          } catch (_) { /* ignore */ }
        }
        // Sinon, charge maintenant
        const theme = document.getElementById('select-theme').value || '';
        const url = new URL(`${API_BASE}/questions`);
        url.searchParams.set('limit', String(limit));
        if (theme) url.searchParams.set('theme', theme);
        const res = await fetch(url);
        if (!res.ok) throw new Error("Erreur API");
        const data = await res.json();
        localStorage.setItem("misk_quiz_set", JSON.stringify(data));
        localStorage.setItem("misk_quiz_limit", String(limit));
        localStorage.setItem("misk_quiz_theme", theme || "");
      } catch (e) {
        console.error(e);
        throw e;
      }
    }

    // Bouton : démarrer quiz
    document.getElementById("btn-start-quiz").addEventListener("click", async (ev) => {
      const btn = ev.currentTarget;
      btn.disabled = true;
      const limit = parseInt(document.getElementById("select-limit").value, 10) || 5;
      try {
        localStorage.setItem("misk_quiz_limit", String(limit));
        await ensureQuizSet(limit);
        // Crée aussi une session côté serveur et conserve quiz_id
        if (!["prof", "admin"].includes(role)) {
          alert("Seuls les profs ou admins peuvent créer un quiz.");
        } else {
          const name = (document.getElementById('input-quiz-name').value || '').trim() || null;
          const theme = document.getElementById('select-theme').value || null;
          const res = await fetch(`${API_BASE}/quiz/create`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username: user, limit, name, theme })
          });
          if (res.ok) {
            const body = await res.json();
            localStorage.setItem("misk_quiz_id", body.quiz_id);
            if (body.name) localStorage.setItem("misk_quiz_name", body.name);
            if (body.theme) localStorage.setItem("misk_quiz_theme", body.theme);
          } else {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.detail || "Création de session serveur échouée");
          }
        }
        window.location.href = "quiz.html";
      } catch (_) {
        alert("Impossible de préparer le quiz.");
      } finally {
        btn.disabled = false;
      }
    });

    // Changer la limite et recharger
    document.getElementById("btn-refresh").addEventListener("click", () => {
      const limit = parseInt(document.getElementById("select-limit").value, 10) || 5;
      loadQuestions(limit);
    });

    // Rafraîchir automatiquement quand on change 5/10
    document.getElementById("select-limit").addEventListener("change", (e) => {
      const limit = parseInt(e.target.value, 10) || 5;
      loadQuestions(limit);
    });

    document.getElementById('select-theme').addEventListener('change', () => {
      const limit = parseInt(document.getElementById("select-limit").value, 10) || 5;
      loadQuestions(limit);
    });

    // Sauvegarder le quiz sans le lancer (profs/admins)
    const btnSaveQuiz = document.getElementById('btn-save-quiz');
    if (btnSaveQuiz) {
      btnSaveQuiz.addEventListener('click', async (ev) => {
        if (!['prof', 'admin'].includes(role)) {
          alert('Seuls les profs/admin peuvent sauvegarder un quiz.');
          return;
        }
        const btn = ev.currentTarget;
        btn.disabled = true;
        try {
          const limit = parseInt(document.getElementById('select-limit').value, 10) || 5;
          const name = (document.getElementById('input-quiz-name').value || '').trim() || null;
          const theme = document.getElementById('select-theme').value || null;
          // Crée une session côté serveur (qui renverra la série sauvegardée)
          const res = await fetch(`${API_BASE}/quiz/create`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: user, limit, name, theme })
          });
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.detail || 'Impossible de sauvegarder');
          }
          const body = await res.json();
          // Mémorise et synchronise l'UI avec la série réellement sauvegardée
          localStorage.setItem('misk_quiz_id', body.quiz_id);
          localStorage.setItem('misk_quiz_limit', String(body.limit || limit));
          if (body.name) localStorage.setItem('misk_quiz_name', body.name);
          if (body.theme) localStorage.setItem('misk_quiz_theme', body.theme);
          if (Array.isArray(body.questions)) {
            localStorage.setItem('misk_quiz_set', JSON.stringify(body.questions));
            // Rafraîchir l'aperçu pour correspondre exactement au quiz sauvegardé
            const list = document.getElementById('questions-list');
            list.innerHTML = '';
            body.questions.forEach((q) => {
              const item = document.createElement('div');
              item.className = 'list-group-item';
              item.innerHTML = `
                <h6>${q.question}</h6>
                <p class="small-muted">Thème : ${q.theme} | Test : ${q.test}</p>
                <ul class="list-group">
                  ${q.choix.map(c => `<li class="list-group-item"> ${c}</li>`).join("")}
                </ul>
              `;
              list.appendChild(item);
            });
          }
          // Confirmation simple
          alert('Quiz sauvegardé avec succès.');
        } catch (err) {
          console.error(err);
          alert(err.message || 'Erreur lors de la sauvegarde');
        } finally {
          btn.disabled = false;
        }
      });
    }

    // Charger au démarrage
    // Initialise la sélection avec valeur précédente si dispo
    const savedLimit = parseInt(localStorage.getItem("misk_quiz_limit") || "5", 10);
    document.getElementById("select-limit").value = String([5, 10].includes(savedLimit) ? savedLimit : 5);
    loadQuestions(savedLimit);

    // Charger la liste des thèmes
    (async function loadThemes() {
      try {
        const res = await fetch(`${API_BASE}/themes`);
        if (!res.ok) return;
        const themes = await res.json();
        const sel = document.getElementById('select-theme');
        themes.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t;
          opt.textContent = t;
          sel.appendChild(opt);
        });


        // Pré-sélection si déjà choisie précédemment
        const savedTheme = localStorage.getItem('misk_quiz_theme') || '';
        if (savedTheme && themes.includes(savedTheme)) {
          sel.value = savedTheme;
          loadQuestions(savedLimit);
        }
      } catch (_) { }
    })();

    // Charger la liste des tests
    (async function loadTests() {
      try {
        const res = await fetch(`${API_BASE}/tests`);
        if (!res.ok) return;
        const tests = await res.json();
        const sel = document.getElementById('select-test');
        tests.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t;
          opt.textContent = t;
          sel.appendChild(opt);
        });
      } catch (_) { }
    })();

    // Quand on change de test
    document.getElementById('select-test').addEventListener('change', async () => {
      const test = document.getElementById('select-test').value;
      const themeSelect = document.getElementById('select-theme');

      try {
        let themes = [];

        if (!test) {
          // Si "Tous les tests", récupérer tous les thèmes
          const res = await fetch(`${API_BASE}/themes`);
          if (!res.ok) throw new Error("Erreur API thèmes");
          themes = await res.json();
        } else {
          // Sinon, récupérer seulement les thèmes pour ce test
          const res = await fetch(`${API_BASE}/themes_by_test/${encodeURIComponent(test)}`);
          if (!res.ok) throw new Error("Erreur API thèmes");
          themes = await res.json();
        }

        // Mettre à jour le select des thèmes
        themeSelect.innerHTML = '';
        const optAll = document.createElement('option');
        optAll.value = '';
        optAll.textContent = 'Tous les thèmes';
        themeSelect.appendChild(optAll);

        themes.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t;
          opt.textContent = t;
          themeSelect.appendChild(opt);
        });

        // Recharge les questions
        const limit = parseInt(document.getElementById('select-limit').value, 10) || 5;
        loadQuestions(limit);
      } catch (err) {
        console.error(err);
      }
    });

    // Quand on change de thème (filtrage croisé)
    document.getElementById('select-theme').addEventListener('change', async () => {
      const theme = document.getElementById('select-theme').value;
      const testSelect = document.getElementById('select-test');

      try {
        let tests = [];

        if (!theme) {
          // Si "Tous les thèmes", récupérer tous les tests
          const res = await fetch(`${API_BASE}/tests`);
          if (!res.ok) throw new Error("Erreur API tests");
          tests = await res.json();
        } else {
          // Sinon, récupérer seulement les tests pour ce thème
          const res = await fetch(`${API_BASE}/tests_by_theme/${encodeURIComponent(theme)}`);
          if (!res.ok) throw new Error("Erreur API tests");
          tests = await res.json();
        }

        // Mettre à jour le select des tests
        testSelect.innerHTML = '';
        const optAll = document.createElement('option');
        optAll.value = '';
        optAll.textContent = 'Tous les tests';
        testSelect.appendChild(optAll);

        tests.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t;
          opt.textContent = t;
          testSelect.appendChild(opt);
        });

        // Recharge les questions
        const limit = parseInt(document.getElementById("select-limit").value, 10) || 5;
        loadQuestions(limit);
      } catch (err) {
        console.error(err);
      }
    });


    // --- Sélecteur de quiz sauvegardés ---
    async function openSavedQuizPicker() {
      try {
        const scope = (role === 'admin') ? 'all' : undefined;
        const url = new URL(`${API_BASE}/quiz`);
        url.searchParams.set('username', user);
        if (scope) url.searchParams.set('scope', scope);
        const res = await fetch(url);
        if (!res.ok) throw new Error('Erreur API');
        const items = await res.json();
        if (!Array.isArray(items) || items.length === 0) {
          alert('Aucun quiz sauvegardé.');
          return;
        }

        // Petite modale simple en JS natif
        const choices = items.map((it, i) => `${i + 1}. ${it.name ? '“' + it.name + '” ' : ''}[${it.limit}]${it.theme ? ' · ' + it.theme : ''} ${it.user} - ${new Date(it.created_at || '').toLocaleString()}\n   ${it.preview}`).join('\n\n');
        const pick = prompt(`Sélectionnez un numéro de quiz:\n\n${choices}\n\nEntrez un numéro (1-${items.length}):`);
        const idx = parseInt(pick || '', 10) - 1;
        if (!(idx >= 0 && idx < items.length)) return;
        const chosen = items[idx];
        // Charger la session choisie et pousser dans le cache local pour le quiz
        const detail = await fetch(`${API_BASE}/quiz/${encodeURIComponent(chosen.quiz_id)}`);
        if (!detail.ok) throw new Error('Lecture du quiz impossible');
        const doc = await detail.json();
        localStorage.setItem('misk_quiz_id', doc.quiz_id);
        localStorage.setItem('misk_quiz_limit', String(doc.limit || doc.questions?.length || 5));
        if (doc.name) localStorage.setItem('misk_quiz_name', doc.name);
        if (doc.theme) localStorage.setItem('misk_quiz_theme', doc.theme);
        localStorage.setItem('misk_quiz_set', JSON.stringify(doc.questions || []));
        window.location.href = 'quiz.html';
      } catch (err) {
        console.error(err);
        alert(err.message || 'Impossible de lister les quiz');
      }
    }

    const btnChoose = document.getElementById('btn-choose-quiz');
    if (btnChoose) btnChoose.addEventListener('click', openSavedQuizPicker);
  </script>
  <!-- Background music (tiny inline script for autoplay policies) -->
  <audio id="bgm" src="assets/bg.mp3" preload="auto" loop hidden></audio>
  <script>
    (function () {
      const audio = document.getElementById('bgm');
      if (!audio) return;
      const KEY_START = 'misk_bgm_start_ms';
      const KEY_VOL = 'misk_bgm_vol';
      const now = Date.now();
      if (!localStorage.getItem(KEY_START)) {
        localStorage.setItem(KEY_START, String(now));
      }
      const startMs = parseInt(localStorage.getItem(KEY_START) || String(now), 10) || now;
      const vol = parseFloat(localStorage.getItem(KEY_VOL) || '0.25');

      function setOffset() {
        const dur = audio.duration;
        if (isFinite(dur) && dur > 0) {
          const elapsed = (Date.now() - startMs) / 1000;
          audio.currentTime = (elapsed % dur);
        }
      }

      function resume() {
        audio.muted = false;
        audio.volume = vol;
        setOffset();
        const p = audio.play();
        if (p && typeof p.then === 'function') {
          p.then(() => {
            document.removeEventListener('pointerdown', resume);
            document.removeEventListener('keydown', resume);
          }).catch(() => { });
        } else {
          document.removeEventListener('pointerdown', resume);
          document.removeEventListener('keydown', resume);
        }
      }

      audio.addEventListener('loadedmetadata', setOffset);
      audio.volume = vol;
      setOffset();
      audio.play().catch(() => { });
      document.addEventListener('pointerdown', resume, { once: true });
      document.addEventListener('keydown', resume, { once: true });
      audio.addEventListener('volumechange', () => {
        localStorage.setItem(KEY_VOL, String(audio.volume));
      });
    })();
  </script>
</body>

</html>