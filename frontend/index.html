<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Miskatonic Quiz - Connexion</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
  <!-- Bootstrap first -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Then custom theme to override Bootstrap -->
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Barre de navigation -->
  <nav class="navbar shadow-sm mb-4">
    <div class="container">
      <span class="brand">Miskatonic Quiz</span>
    </div>
  </nav>

  <!-- Contenu principal -->
  <main class="container">
    <div class="row justify-content-center">
      <div class="col-md-6">
        <!-- Carte Connexion -->
        <div class="card">
          <h2 class="mb-3">Connexion</h2>
          <form id="form-login">
            <div class="mb-3">
              <label class="form-label">Nom d'utilisateur</label>
              <input id="login-username" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Mot de passe</label>
              <input id="login-password" type="password" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Se connecter</button>
          </form>
        </div>

        <!-- Carte Inscription -->
        <div class="card mt-4">
          <h2 class="mb-3">Cr√©er un compte</h2>
          <form id="form-register">
            <div class="mb-3">
              <label class="form-label">Nom d'utilisateur</label>
              <input id="reg-username" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Mot de passe</label>
              <input id="reg-password" type="password" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">R√¥le</label>
              <select id="reg-role" class="form-select">
                <option value="prof">Professeur</option>
                <option value="eleve">√âl√®ve</option>
                <option value="admin">Administrateur</option>
              </select>
            </div>
            <button type="submit" class="btn btn-outline-primary w-100">S'inscrire</button>
          </form>
        </div>
      </div>
    </div>
  </main>

  <!-- JS -->
  <script>
    const API_BASE = "http://127.0.0.1:8000";

    // --- Connexion ---
    document.getElementById('form-login').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;
      try {
        const res = await fetch(`${API_BASE}/login`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ username, password })
        });
        if (res.ok) {
          const body = await res.json();
          localStorage.setItem('misk_user', username);
          localStorage.setItem('misk_role', body.role); // üëà stocke aussi le r√¥le
          alert(`Connexion r√©ussie en tant que ${body.role}`);
          window.location.href = "questions.html";
        } else {
          const err = await res.json();
          alert("Erreur de connexion : " + (err.detail || res.status));
        }
      } catch (err) {
        alert("Erreur r√©seau");
        console.error(err);
      }
    });

    // --- Inscription ---
    document.getElementById('form-register').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('reg-username').value.trim();
      const password = document.getElementById('reg-password').value;
      const role = document.getElementById('reg-role').value;  // üëà r√©cup√®re le r√¥le

      try {
        const res = await fetch(`${API_BASE}/register`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ username, password, role })
        });
        if (res.ok) {
          alert("Compte cr√©√© avec succ√®s, connectez-vous !");
          document.getElementById('form-register').reset();
        } else {
          const err = await res.json();
          alert("Erreur √† l'inscription : " + (err.detail || res.status));
        }
      } catch (err) {
        alert("Erreur r√©seau");
        console.error(err);
      }
    });
  </script>
  <!-- Background music (tiny inline script for autoplay policies) -->
  <audio id="bgm" src="assets/bg.mp3" preload="auto" loop hidden></audio>
  <script>
    (function(){
      const audio = document.getElementById('bgm');
      if (!audio) return;
      const KEY_START = 'misk_bgm_start_ms';
      const KEY_VOL = 'misk_bgm_vol';
      const now = Date.now();
      if (!localStorage.getItem(KEY_START)) {
        localStorage.setItem(KEY_START, String(now));
      }
      const startMs = parseInt(localStorage.getItem(KEY_START) || String(now), 10) || now;
      const vol = parseFloat(localStorage.getItem(KEY_VOL) || '0.25');

      function setOffset() {
        const dur = audio.duration;
        if (isFinite(dur) && dur > 0) {
          const elapsed = (Date.now() - startMs) / 1000;
          audio.currentTime = (elapsed % dur);
        }
      }

      function resume() {
        audio.muted = false;
        audio.volume = vol;
        setOffset();
        const p = audio.play();
        if (p && typeof p.then === 'function') {
          p.then(() => {
            document.removeEventListener('pointerdown', resume);
            document.removeEventListener('keydown', resume);
          }).catch(() => {});
        } else {
          document.removeEventListener('pointerdown', resume);
          document.removeEventListener('keydown', resume);
        }
      }

      audio.addEventListener('loadedmetadata', setOffset);
      audio.volume = vol;
      setOffset();
      audio.play().catch(() => {});
      document.addEventListener('pointerdown', resume, { once: true });
      document.addEventListener('keydown', resume, { once: true });
      audio.addEventListener('volumechange', () => {
        localStorage.setItem(KEY_VOL, String(audio.volume));
      });
    })();
  </script>
</body>
</html>
